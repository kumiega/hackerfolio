---
import Layout from "@/layouts/layout-portfolio.astro";
import BioSection from "@/components/page/portfolio/bio.astro";
import SectionRenderer from "@/components/page/portfolio/section-renderer.astro";
import Footer from "@/components/page/portfolio/footer.astro";
import PixelBlast from "@/components/ui/pixel-blast";
import type { Component } from "@/types";

import "@/styles/portfolio.css";

export const prerender = false;

const { params, locals } = Astro;
const username = params.username;

// Check authentication
if (!locals.user) {
  return Astro.redirect("/signin");
}

// Check if user owns this portfolio
if (locals.user.username !== username) {
  return Astro.redirect("/dashboard");
}

// Fetch preview data from API
const response = await fetch(`${Astro.url.origin}/api/v1/preview/portfolios/${username}`, {
  headers: {
    Cookie: Astro.request.headers.get("cookie") || "",
  },
});

if (!response.ok) {
  if (response.status === 404) {
    return Astro.redirect("/dashboard");
  }
  throw new Error(`Failed to fetch preview data: ${response.status}`);
}

const apiResponse = await response.json();
const previewData = apiResponse.data;

// Extract data from the API response
const data = previewData.draft_data;

const socialLinks = data.bio
  .filter((component: Component) => component.type === "social_links" && component.visible !== false)
  .reduce(
    (links: Record<string, string>, component: Component) => {
      const componentData = component.data as {
        github?: string;
        linkedin?: string;
        x?: string;
        website?: { name: string; url: string }[];
      };
      if (componentData.github && componentData.github.trim()) links.github = componentData.github;
      if (componentData.linkedin && componentData.linkedin.trim()) links.linkedin = componentData.linkedin;
      if (componentData.x && componentData.x.trim()) links.twitter = componentData.x;
      if (componentData.website && componentData.website.length > 0) {
        componentData.website.forEach((site) => {
          if (site.name?.trim() && site.url?.trim() && site.name?.toLowerCase().includes("blog")) {
            links.blog = site.url;
          }
        });
      }
      return links;
    },
    {} as Record<string, string>
  );

const bioText = data.bio
  .filter((component: Component) => component.type === "text" && component.visible !== false)
  .map((component: Component) => (component.data as { content: string }).content)
  .join(" ");

const fullName =
  data.bio
    .filter((component: Component) => component.type === "personal_info" && component.visible !== false)
    .map((component: Component) => (component.data as { full_name: string }).full_name)
    .join(" ") || "Your Name";

const avatarUrl =
  data.bio
    .filter((component: Component) => component.type === "avatar" && component.visible !== false)
    .map((component: Component) => (component.data as { avatar_url: string }).avatar_url)
    .join(" ") || "/images/avatar.jpg";

const position =
  data.bio
    .filter((component: Component) => component.type === "personal_info" && component.visible !== false)
    .map((component: Component) => (component.data as { position?: string }).position)
    .filter(Boolean)
    .join(" ") || null;
---

<Layout title="Portfolio - Hackerfolio">
  <div class="max-w-[480px] mx-auto pt-24 px-5 relative z-[1] flex-1">
    <BioSection name={fullName} title={position} description={bioText} avatarSrc={avatarUrl} links={socialLinks} />

    <main>
      <SectionRenderer sections={data.sections} />
    </main>
  </div>
  <div class="absolute top-0 left-0 h-[33vh] w-full">
    <PixelBlast client:load color="#E5E5E5" />
  </div>
  <Footer copyrightYear="2025" copyrightText="© All rights reserved." madeWithText="» Made with" madeWithUrl="/" />
</Layout>
