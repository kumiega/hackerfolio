---
import Layout from "@/layouts/layout-portfolio.astro";
import BioSection from "@/components/page/portfolio/bio.astro";
import SectionRenderer from "@/components/page/portfolio/section-renderer.astro";
import Footer from "@/components/page/portfolio/footer.astro";
import PixelBlast from "@/components/ui/pixel-blast";
import { ModeToggle } from "@/components/ui/mode-toggle";

import "@/styles/portfolio.css";

export const prerender = false;

// Extract subdomain from the hostname
function getSubdomain(hostname: string, baseUrl?: string): string | null {
  // Remove port if present
  const cleanHostname = hostname.split(":")[0];

  // If baseUrl is provided, extract domain from it
  let baseDomain = import.meta.env.PUBLIC_BASE_DOMAIN;
  if (baseUrl) {
    try {
      const url = new URL(baseUrl);
      baseDomain = url.hostname;
    } catch {
      // Ignore invalid URLs
    }
  }

  // Skip localhost/development environments - use /public route instead
  if (cleanHostname.includes("localhost") || cleanHostname.includes("127.0.0.1") || cleanHostname.includes("0.0.0.0")) {
    return null;
  }

  // For production domains, check if hostname ends with our base domain
  if (cleanHostname.endsWith(`.${baseDomain}`)) {
    const subdomain = cleanHostname.replace(`.${baseDomain}`, "");
    // Return null if it's the main domain (no subdomain)
    return subdomain && subdomain !== baseDomain ? subdomain : null;
  }

  return null;
}

const { request } = Astro;
const url = new URL(request.url);
const hostname = request.headers.get("host") || url.hostname;

// Get subdomain
const username = getSubdomain(hostname, import.meta.env.PUBLIC_BASE_URL);

// If no subdomain, this is the main domain - redirect to homepage
if (!username) {
  return Astro.redirect("/", 302);
}

// Validate username format (same regex as user registration)
const usernameRegex = /^[a-z0-9-]{3,30}$/;
if (!usernameRegex.test(username)) {
  return Astro.redirect("/404", 302);
}

// Fetch portfolio data from public API
const apiUrl = `${url.origin}/api/v1/public/portfolios/${username}`;
const response = await fetch(apiUrl, {
  headers: {
    // Forward any necessary headers
    "User-Agent": request.headers.get("user-agent") || "",
  },
});

// Handle API errors
if (!response.ok) {
  if (response.status === 404) {
    return Astro.redirect("/404", 302);
  }
  throw new Error(`Failed to fetch portfolio data: ${response.status}`);
}

const apiResponse = await response.json();
const portfolioData = apiResponse.data;

// Extract data from the API response
const data = portfolioData.published_data;

const fullName = data.bio.full_name || "";
const position = data.bio.position || null;
const bioText = data.bio.summary || "";
const avatarUrl = data.bio.avatar_url || null;
const socialLinks = data.bio.social_links || {};

// Set page title
const pageTitle = `${fullName}${position ? ` - ${position}` : ""} | Hackerfolio`;
---

<Layout title={pageTitle}>
  <!-- Theme toggle floating button -->
  <div class="fixed top-4 right-4 z-50">
    <ModeToggle client:load />
  </div>

  <div class="max-w-[480px] w-full mx-auto pt-24 px-5 relative z-[1] flex-1">
    <BioSection name={fullName} title={position} description={bioText} avatarSrc={avatarUrl} links={socialLinks} />

    <main>
      <SectionRenderer sections={data.sections} />
    </main>
  </div>
  <div class="absolute top-0 left-0 h-[33vh] w-full">
    <PixelBlast client:only="react" />
  </div>
  <Footer copyrightYear="2025" copyrightText="© All rights reserved." madeWithText="» Made with" madeWithUrl="/" />
</Layout>
